<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Success - CodelessAI</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0d1117 0%, #161b22 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #e6edf3;
    }
    .container {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 12px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .success-icon {
      width: 64px;
      height: 64px;
      background: #238636;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }
    .success-icon svg { width: 32px; height: 32px; color: #fff; }
    .title { font-size: 24px; font-weight: 700; margin-bottom: 12px; }
    .subtitle { color: #8b949e; font-size: 14px; margin-bottom: 32px; line-height: 1.6; }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      margin: 8px;
    }
    .btn-primary { background: #238636; color: #fff; }
    .btn-primary:hover { background: #2ea043; }
    .btn-secondary {
      background: #21262d;
      border: 1px solid #30363d;
      color: #e6edf3;
    }
    .btn-secondary:hover { background: #30363d; }
    .divider { height: 1px; background: #30363d; margin: 24px 0; }
    .info { font-size: 12px; color: #8b949e; }
    .info a { color: #58a6ff; text-decoration: none; }
    .info a:hover { text-decoration: underline; }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #30363d;
      border-top-color: #58a6ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container" id="loadingState">
    <div class="spinner"></div>
    <h1 class="title">Processing...</h1>
    <p class="subtitle">Please wait while we complete your authentication.</p>
  </div>

  <div class="container hidden" id="successState">
    <div class="success-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
    </div>
    <h1 class="title">You're all set!</h1>
    <p class="subtitle">
      Your account is ready.<br/>
      Click below to open VS Code and start coding with CodelessAI.
    </p>
    
    <a href="#" class="btn btn-primary" id="openVscode">
      Open VS Code
    </a>
    <button class="btn btn-secondary" onclick="window.close()">
      Close this tab
    </button>
    
    <div class="divider"></div>
    
    <p class="info">
      VS Code not opening? <a href="#" id="manualLink">Copy the link</a>
    </p>
  </div>

  <div class="container hidden" id="pendingState">
    <div class="success-icon" style="background: #58a6ff;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
        <polyline points="22,6 12,13 2,6"/>
      </svg>
    </div>
    <h1 class="title">Check your email</h1>
    <p class="subtitle">
      We've sent you a confirmation link.<br/>
      Please check your email and click the link to complete signup.
    </p>
    
    <a href="login.html" class="btn btn-secondary">
      Go to Sign In
    </a>
  </div>

  <div class="container hidden" id="errorState">
    <div class="success-icon" style="background: #f85149;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="15" y1="9" x2="9" y2="15"/>
        <line x1="9" y1="9" x2="15" y2="15"/>
      </svg>
    </div>
    <h1 class="title">Something went wrong</h1>
    <p class="subtitle" id="errorMessage">
      Authentication failed. Please try again.
    </p>
    
    <a href="login.html" class="btn btn-primary">
      Try Again
    </a>
  </div>
  
  <script>
    const SUPABASE_URL = 'https://sizwtijdyjnamnppcwyy.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpend0aWpkeWpuYW1ucHBjd3l5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MTAwNTIsImV4cCI6MjA4MDI4NjA1Mn0.q64OGNZ6pwpRurZST9Vu0RlKhqGSKhLmoc1Hdto5XGI';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showState(stateId) {
      ['loadingState', 'successState', 'pendingState', 'errorState'].forEach(id => {
        document.getElementById(id).classList.toggle('hidden', id !== stateId);
      });
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      showState('errorState');
    }

    function buildVscodeUrl(accessToken, refreshToken) {
      const params = new URLSearchParams({
        access_token: accessToken,
        refresh_token: refreshToken || '',
      });
      return 'vscode://codelessai.codeless-ai/auth?' + params.toString();
    }

    async function handleAuth() {
      // Check URL parameters first (from email/password login)
      const urlParams = new URLSearchParams(window.location.search);
      
      // Check for confirmation pending
      if (urlParams.get('confirmation') === 'pending') {
        showState('pendingState');
        return;
      }

      // Check for tokens in URL params (from our login page)
      let accessToken = urlParams.get('access_token');
      let refreshToken = urlParams.get('refresh_token');

      // Check hash fragment (from OAuth redirect)
      if (!accessToken && window.location.hash) {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        accessToken = hashParams.get('access_token');
        refreshToken = hashParams.get('refresh_token');
        
        // Also check for error in hash
        const error = hashParams.get('error_description') || hashParams.get('error');
        if (error) {
          showError(decodeURIComponent(error));
          return;
        }
      }

      // If we have tokens, set session and redirect to VS Code
      if (accessToken) {
        try {
          // Verify the session is valid
          const { data, error } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken || '',
          });

          if (error) throw error;

          const vscodeUrl = buildVscodeUrl(accessToken, refreshToken);
          
          document.getElementById('openVscode').href = vscodeUrl;
          document.getElementById('manualLink').onclick = (e) => {
            e.preventDefault();
            navigator.clipboard.writeText(vscodeUrl);
            alert('Link copied to clipboard!');
          };

          showState('successState');

          // Auto-redirect after 1 second
          setTimeout(() => {
            window.location.href = vscodeUrl;
          }, 1000);

        } catch (err) {
          showError(err.message || 'Failed to verify authentication');
        }
      } else {
        // Check if we have an active session (might be from page reload)
        const { data: { session } } = await supabase.auth.getSession();
        
        if (session) {
          const vscodeUrl = buildVscodeUrl(session.access_token, session.refresh_token);
          document.getElementById('openVscode').href = vscodeUrl;
          document.getElementById('manualLink').onclick = (e) => {
            e.preventDefault();
            navigator.clipboard.writeText(vscodeUrl);
            alert('Link copied to clipboard!');
          };
          showState('successState');
          
          setTimeout(() => {
            window.location.href = vscodeUrl;
          }, 1000);
        } else {
          showError('No authentication data found. Please try signing in again.');
        }
      }
    }

    // Run on page load
    handleAuth();
  </script>
</body>
</html>
